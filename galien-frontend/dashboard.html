<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Galien - Tableau de bord</title>
<link rel="icon" type="image/svg+xml" href="assets/galien-icon.svg">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="dashboard-wrap">
  <div class="dash-topbar">
    <div class="dash-brand brand-with-icon topbar-logo" aria-label="Galien">
      <img src="assets/galien-icon.svg" alt="Galien" class="brand-icon">
    </div>
    <div id="dashUserArea"></div>
  </div>

  <div class="dashboard-main">
    <div class="dashboard-card">
      <h2>Nouvelle session</h2>
      <p class="muted" style="margin-bottom:22px">Choisissez votre mode, filtrez par module, cours ou source, puis lancez.</p>

      <div class="mode-cards">
        <button class="mode-card selected" id="modeTraining" type="button">
          <div class="mode-card-icon"><i class="bi bi-lightning-charge-fill"></i></div>
          <h4>Entrainement</h4>
          <p>Correction immediate avec explications. Avance automatique possible.</p>
        </button>
        <button class="mode-card" id="modeExam" type="button">
          <div class="mode-card-icon"><i class="bi bi-clock-fill"></i></div>
          <h4>Examen</h4>
          <p>Minuteur, pas d'explication pendant la session. Resultats a la fin.</p>
        </button>
      </div>

      <!-- Hidden native selects â€” read by dashboard.js unchanged -->
      <select id="sel_module" class="multi-select" multiple style="display:none"></select>
      <select id="sel_course" class="multi-select" multiple style="display:none"></select>
      <select id="sel_source" class="multi-select" multiple style="display:none"></select>
      <select id="sel_favtag" class="multi-select" multiple style="display:none"></select>

      <!-- Wizard filter builder -->
      <div class="dash-panel wb-panel">
        <div class="wb-header">
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            <div class="dash-panel-title" style="margin-bottom:0"><i class="bi bi-funnel"></i> Filtres de session</div>
            <div class="filter-mode-switch">
              <button type="button" class="mode-pill active" id="wbGuidedBtn">Filtre guide</button>
              <button type="button" class="mode-pill" id="wbAdvancedBtn">Filtre non guide</button>
            </div>
          </div>
          <button class="filter-reset-btn" id="filterResetBtn" type="button">
            <i class="bi bi-arrow-counterclockwise"></i> Reinitialiser
          </button>
        </div>
        <div id="wb-guided-mode">
          <div id="wb-blocks"></div>
          <div id="wb-wizard"></div>
          <div id="wb-add-wrap" style="display:none;padding:12px 0 0">
            <button class="wb-add-btn" id="wb-add-btn" type="button">
              <i class="bi bi-plus-circle"></i> Ajouter un autre module
            </button>
          </div>
        </div>
        <div id="wb-advanced-mode" class="hidden">
          <div class="wb-advanced-grid">
            <label class="field" style="margin-bottom:0">
              <span>Modules</span>
              <select id="wb_adv_module" multiple size="6"></select>
            </label>
            <label class="field" style="margin-bottom:0">
              <span>Cours</span>
              <select id="wb_adv_course" multiple size="6"></select>
            </label>
            <label class="field" style="margin-bottom:0">
              <span>Sources</span>
              <select id="wb_adv_source" multiple size="6"></select>
            </label>
            <label class="field" style="margin-bottom:0">
              <span>Tags favoris</span>
              <select id="wb_adv_favtag" multiple size="6"></select>
            </label>
          </div>
          <p class="muted" style="font-size:.75rem;margin-top:8px">Mode libre: maintenez Ctrl pour selection multiple.</p>
        </div>
        <div class="filters-count-wrap" style="margin-top:12px">
          <div class="question-counter">
            <span class="question-counter-num js-questions-count">...</span>
            <span class="question-counter-label">questions disponibles</span>
          </div>
        </div>
      </div>
      <div class="dash-panel" id="trainingPanel">
        <div class="dash-panel-title"><i class="bi bi-lightning-charge"></i> Options entrainement</div>
        <div class="filters-row" style="margin-bottom:12px">
          <div class="field" style="margin-bottom:0">
            <span>Systeme de correction</span>
            <select id="training_correction_system">
              <option value="tout_ou_rien">Tout ou rien</option>
              <option value="partiel_positive">Partiel positif</option>
              <option value="partiel_negative">Partiel negatif</option>
            </select>
          </div>
          <div class="field" style="margin-bottom:0">
            <div class="qcount-slider-wrap">
              <div class="slider-header">
                <span>Nombre de questions</span>
                <div class="slider-count">
                  <strong id="training_question_count_value">1 <span>questions</span></strong>
                </div>
              </div>
              <input type="range" id="training_question_count" min="1" value="1">
              <div class="slider-ends">
                <span>1</span>
                <span id="training_slider_max">â€”</span>
              </div>
            </div>
          </div>
        </div>
        <div class="toggle-row" style="border-top:none;padding-top:0">
          <div class="toggle-label">
            Avance automatique apres correction
            <small>Passe a la question suivante automatiquement</small>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="autoAdvanceToggle">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div id="delayPanel" class="hidden" style="margin-top:12px">
          <div class="delay-row">
            <div class="field" style="margin-bottom:0">
              <span>Delai rapide</span>
              <select id="delayPreset">
                <option value="2">2 secondes</option>
                <option value="5">5 secondes</option>
                <option value="10">10 secondes</option>
                <option value="custom">Personnalise...</option>
              </select>
            </div>
            <div class="delay-input-wrap hidden" id="customDelayWrap">
              <span>Secondes</span>
              <input type="number" id="customDelay" min="1" max="60" placeholder="Ex: 7" style="width:90px">
            </div>
          </div>
        </div>
      </div>

      <div class="dash-panel hidden" id="examPanel">
        <div class="dash-panel-title"><i class="bi bi-clock"></i> Options examen</div>
        <div class="filters-row" style="margin-bottom:12px">
          <div class="field" style="margin-bottom:0">
            <span>Duree (minutes)</span>
            <input type="number" id="exam_minutes" min="1" placeholder="Ex: 30">
          </div>
          <div class="field" style="margin-bottom:0">
            <span>Systeme de correction</span>
            <select id="correction_system">
              <option value="tout_ou_rien">Tout ou rien</option>
              <option value="partiel_positive">Partiel positif</option>
              <option value="partiel_negative">Partiel negatif</option>
            </select>
          </div>
          <div class="field" style="margin-bottom:0">
            <div class="qcount-slider-wrap">
              <div class="slider-header">
                <span>Nombre de questions</span>
                <div class="slider-count">
                  <strong id="exam_question_count_value">1 <span>questions</span></strong>
                </div>
              </div>
              <input type="range" id="exam_question_count" min="1" value="1">
              <div class="slider-ends">
                <span>1</span>
                <span id="exam_slider_max">â€”</span>
              </div>
            </div>
          </div>
        </div>
        <div class="help-text" id="correctionHelp">Vous devez cocher toutes les bonnes reponses et uniquement celles-ci.</div>
      </div>

      <button class="btn start-btn" id="startBtn" type="button"><i class="bi bi-play-fill"></i> Commencer</button>
      <button class="btn ghost hidden" id="resumeBtn" type="button" style="margin-top:8px"><i class="bi bi-arrow-counterclockwise"></i> Reprendre la session en cours</button>
    </div>
  </div>
</div>

<script src="js/api.js"></script>
<script src="js/theme.js"></script>
<script src="js/dashboard.js"></script>
<script>
/* Wizard filters: guided + non-guided */
const WB_CLASSES = {
  biologiques: {
    id: 'biologiques',
    name: 'Biologiques',
    icon: 'bi-capsule-pill',
    color: '#0d9488',
    ghost: '#f0fdfa',
    desc: 'Biochimie, Hemobiologie, Microbiologie, Parasitologie, Immunologie'
  },
  fondamentaux: {
    id: 'fondamentaux',
    name: 'Fondamentaux',
    icon: 'bi-bezier2',
    color: '#4f46e5',
    ghost: '#eef2ff',
    desc: 'Biophysique, Chimie analytique, Chimie minerale, Hydro bromatologie'
  },
  pharmaceutiques: {
    id: 'pharmaceutiques',
    name: 'Pharmaceutiques',
    icon: 'bi-heart-pulse',
    color: '#d97706',
    ghost: '#fffbeb',
    desc: 'Pharmacologie, Toxicologie, Pharmacie galenique, etc.'
  }
};

const WB_MODULE_ICONS = {
  biochimie: 'bi-droplet-half',
  hemobiologie: 'bi-virus2',
  microbiologie: 'bi-bug',
  parasitologie: 'bi-shield-bug',
  immunologie: 'bi-shield-check',
  biophysique: 'bi-rulers',
  'chimie analytique': 'bi-beaker',
  'chimie minerale': 'bi-gem',
  'hydro bromatologie': 'bi-cup-straw',
  pharmacologie: 'bi-capsule',
  toxicologie: 'bi-exclamation-triangle',
  'pharmacie galenique': 'bi-box-seam',
  pharmacognosie: 'bi-flower1',
  botanique: 'bi-tree',
  'chimie therapeutique': 'bi-bandaid'
};

let wbBlocks = [];
let wbWizard = null;
let wbEditingIndex = null;
let wbMode = 'guided';
let wbCourseCache = {};
let wbSourceCache = {};
let wbFavtagCache = [];
let wbSyncTimer = null;
let wbLastModuleSignature = '';

function wbNorm(v) {
  return String(v || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
}
function wbModuleIcon(label) {
  return WB_MODULE_ICONS[wbNorm(label)] || 'bi-grid-3x3-gap';
}

(function hookSetOptions() {
  const original = window.setOptions;
  if (typeof original !== 'function') return;
  window.setOptions = function patchedSetOptions(selectEl, items, getLabel, selectedValues) {
    original(selectEl, items, getLabel, selectedValues);

    if (selectEl && selectEl.id === 'sel_favtag') {
      wbFavtagCache = Array.from(selectEl.options).map((o) => ({ id: o.value, label: o.textContent.trim() }));
      wbPopulateAdvancedFromNative();
      if (wbWizard && wbWizard.step === 4) wbRender();
    }
    if (selectEl && selectEl.id === 'sel_course') {
      items.forEach((c) => {
        const mid = String(c.module_id || '');
        if (!mid) return;
        if (!wbCourseCache[mid]) wbCourseCache[mid] = [];
        const id = String(c.id ?? c.value);
        if (!wbCourseCache[mid].find((x) => x.id === id)) wbCourseCache[mid].push({ id, label: getLabel(c) });
      });
      wbPopulateAdvancedFromNative();
    }
    if (selectEl && selectEl.id === 'sel_source') {
      items.forEach((s) => {
        const mid = String(s.module_id || '');
        if (!mid) return;
        if (!wbSourceCache[mid]) wbSourceCache[mid] = [];
        const id = String(s.id ?? s.value);
        if (!wbSourceCache[mid].find((x) => x.id === id)) wbSourceCache[mid].push({ id, label: getLabel(s) });
      });
      wbPopulateAdvancedFromNative();
    }
  };
})();

function wbSetSelectedValues(selectEl, values) {
  if (!selectEl) return;
  const set = new Set((values || []).map(String));
  Array.from(selectEl.options).forEach((o) => {
    o.selected = set.has(String(o.value));
  });
}

function wbClearNativeFilters() {
  ['sel_module', 'sel_course', 'sel_source', 'sel_favtag'].forEach((id) => {
    const el = document.getElementById(id);
    if (!el) return;
    Array.from(el.options).forEach((o) => {
      o.selected = false;
    });
  });
  wbLastModuleSignature = '';
  if (typeof scheduleCountRefresh === 'function') scheduleCountRefresh();
}

function wbGetGuidedEffectiveBlocks() {
  const list = wbBlocks.map((b) => ({ ...b }));
  if (!wbWizard || wbMode !== 'guided' || !wbWizard.moduleId) return list;

  const draft = {
    ...wbWizard,
    courseIds: [...(wbWizard.courseIds || [])],
    sourceIds: [...(wbWizard.sourceIds || [])],
    favtags: wbWizard.favEnabled ? [...(wbWizard.favtags || [])] : []
  };

  if (wbEditingIndex !== null && list[wbEditingIndex]) list[wbEditingIndex] = draft;
  else list.push(draft);
  return list;
}

function wbApplyGuidedFilters() {
  const sm = document.getElementById('sel_module');
  const sc = document.getElementById('sel_course');
  const ss = document.getElementById('sel_source');
  const sf = document.getElementById('sel_favtag');
  if (!sm || !sc || !ss || !sf) return;

  const blocks = wbGetGuidedEffectiveBlocks().filter((b) => b && b.moduleId);
  if (!blocks.length) {
    wbClearNativeFilters();
    return;
  }

  const moduleIds = [...new Set(blocks.map((b) => String(b.moduleId)))];
  const courseIds = [...new Set(blocks.flatMap((b) => b.courseIds || []).map(String))];
  const sourceIds = [...new Set(blocks.flatMap((b) => b.sourceIds || []).map(String))];
  const favtags = [...new Set(blocks.flatMap((b) => (b.favEnabled ? (b.favtags || []) : [])).map(String))];

  wbSetSelectedValues(sm, moduleIds);
  const moduleSig = moduleIds.join(',');
  const moduleChanged = moduleSig !== wbLastModuleSignature;
  wbLastModuleSignature = moduleSig;
  if (moduleChanged) sm.dispatchEvent(new Event('change'));

  clearTimeout(wbSyncTimer);
  wbSyncTimer = setTimeout(() => {
    wbSetSelectedValues(sc, courseIds);
    wbSetSelectedValues(ss, sourceIds);
    wbSetSelectedValues(sf, favtags);
    if (typeof scheduleCountRefresh === 'function') scheduleCountRefresh();
    wbPopulateAdvancedFromNative();
  }, moduleChanged ? 360 : 40);
}

function wbApplyAdvancedFilters() {
  const sm = document.getElementById('sel_module');
  const sc = document.getElementById('sel_course');
  const ss = document.getElementById('sel_source');
  const sf = document.getElementById('sel_favtag');

  const am = document.getElementById('wb_adv_module');
  const ac = document.getElementById('wb_adv_course');
  const as = document.getElementById('wb_adv_source');
  const af = document.getElementById('wb_adv_favtag');
  if (!sm || !sc || !ss || !sf || !am || !ac || !as || !af) return;

  const selectedModules = Array.from(am.selectedOptions).map((o) => o.value);
  const selectedCourses = Array.from(ac.selectedOptions).map((o) => o.value);
  const selectedSources = Array.from(as.selectedOptions).map((o) => o.value);
  const selectedFavTags = Array.from(af.selectedOptions).map((o) => o.value);

  wbSetSelectedValues(sm, selectedModules);
  const moduleSig = selectedModules.join(',');
  const moduleChanged = moduleSig !== wbLastModuleSignature;
  wbLastModuleSignature = moduleSig;
  if (moduleChanged) sm.dispatchEvent(new Event('change'));

  clearTimeout(wbSyncTimer);
  wbSyncTimer = setTimeout(() => {
    wbSetSelectedValues(sc, selectedCourses);
    wbSetSelectedValues(ss, selectedSources);
    wbSetSelectedValues(sf, selectedFavTags);
    if (typeof scheduleCountRefresh === 'function') scheduleCountRefresh();
    wbPopulateAdvancedFromNative();
  }, moduleChanged ? 360 : 40);
}

function wbApplyActiveFilters() {
  if (wbMode === 'advanced') wbApplyAdvancedFilters();
  else wbApplyGuidedFilters();
}

async function wbFetchCourses(moduleId) {
  const mid = String(moduleId);
  if (wbCourseCache[mid]) return wbCourseCache[mid];
  try {
    const res = await fetch(`${API_URL}/courses`);
    if (!res.ok) return [];
    const all = await res.json();
    all.forEach((c) => {
      const moduleKey = String(c.module_id || '');
      if (!moduleKey) return;
      if (!wbCourseCache[moduleKey]) wbCourseCache[moduleKey] = [];
      const id = String(c.id);
      if (!wbCourseCache[moduleKey].find((x) => x.id === id)) {
        wbCourseCache[moduleKey].push({ id, label: c.name });
      }
    });
    return wbCourseCache[mid] || [];
  } catch {
    return [];
  }
}

async function wbFetchSources(moduleId) {
  const mid = String(moduleId);
  if (wbSourceCache[mid]) return wbSourceCache[mid];
  try {
    const res = await fetch(`${API_URL}/sources?module_id=${mid}`);
    if (!res.ok) return [];
    const arr = await res.json();
    wbSourceCache[mid] = arr.map((s) => ({ id: String(s.id), label: s.name }));
    return wbSourceCache[mid];
  } catch {
    return [];
  }
}

function wbStartWizard(editIndex = null) {
  wbEditingIndex = Number.isInteger(editIndex) ? editIndex : null;
  if (wbEditingIndex !== null && wbBlocks[wbEditingIndex]) {
    const base = wbBlocks[wbEditingIndex];
    wbWizard = {
      step: 2,
      classId: base.classId,
      moduleId: base.moduleId,
      moduleLabel: base.moduleLabel,
      availCourses: [...(base.availCourses || [])],
      availSources: [...(base.availSources || [])],
      courseIds: [...(base.courseIds || [])],
      sourceIds: [...(base.sourceIds || [])],
      favtags: [...(base.favtags || [])],
      favEnabled: !!base.favEnabled
    };
  } else {
    wbWizard = {
      step: 0,
      classId: null,
      moduleId: null,
      moduleLabel: '',
      availCourses: [],
      availSources: [],
      courseIds: [],
      sourceIds: [],
      favtags: [],
      favEnabled: false
    };
  }
  wbRender();
  wbApplyActiveFilters();
}

function wbRender() {
  const blocksEl = document.getElementById('wb-blocks');
  const wizardEl = document.getElementById('wb-wizard');
  const addWrap = document.getElementById('wb-add-wrap');
  if (!blocksEl || !wizardEl || !addWrap) return;

  blocksEl.innerHTML = wbBlocks
    .map((b, i) => {
      const cls = WB_CLASSES[b.classId] || WB_CLASSES.pharmaceutiques;
      const moduleIcon = wbModuleIcon(b.moduleLabel);
      const courseChips = (b.courseIds || []).length
        ? b.courseIds
            .map((id) => {
              const c = (b.availCourses || []).find((x) => x.id === id);
              return `<span class="wb-chip wb-chip--course">${c ? c.label : id}</span>`;
            })
            .join('')
        : '<span class="wb-chip wb-chip--muted">Tous les cours</span>';
      const sourceChips = (b.sourceIds || [])
        .map((id) => {
          const s = (b.availSources || []).find((x) => x.id === id);
          return `<span class="wb-chip wb-chip--source"><i class="bi bi-file-earmark-text"></i> ${s ? s.label : id}</span>`;
        })
        .join('');
      const favChips = (b.favEnabled ? b.favtags || [] : []).map((t) => `<span class="wb-chip wb-chip--fav"><i class="bi bi-heart-fill"></i> ${t}</span>`).join('');

      return `<div class="wb-block">
        <div class="wb-block-num" style="background:${cls.color}">${i + 1}</div>
        <div class="wb-block-info">
          <div class="wb-block-title">
            <span class="wb-block-cls" style="color:${cls.color}"><i class="bi ${cls.icon}"></i> ${cls.name}</span>
            <span class="wb-block-mod"><i class="bi ${moduleIcon}"></i> ${b.moduleLabel}</span>
          </div>
          <div class="wb-block-chips">${courseChips}${sourceChips}${favChips}</div>
        </div>
        <div class="wb-block-actions">
          <button class="wb-edit-btn" data-edit="${i}" title="Modifier"><i class="bi bi-pencil-square"></i></button>
          <button class="wb-del-btn" data-del="${i}" title="Supprimer"><i class="bi bi-trash"></i></button>
        </div>
      </div>`;
    })
    .join('');

  blocksEl.querySelectorAll('[data-edit]').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      wbStartWizard(parseInt(btn.dataset.edit, 10));
    });
  });

  blocksEl.querySelectorAll('[data-del]').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const idx = parseInt(btn.dataset.del, 10);
      if (Number.isNaN(idx)) return;
      wbBlocks.splice(idx, 1);
      if (wbEditingIndex === idx) {
        wbWizard = null;
        wbEditingIndex = null;
      } else if (wbEditingIndex !== null && wbEditingIndex > idx) {
        wbEditingIndex -= 1;
      }
      if (!wbBlocks.length && !wbWizard) wbStartWizard();
      wbRender();
      wbApplyActiveFilters();
    });
  });

  addWrap.style.display = wbMode === 'guided' && wbBlocks.length > 0 && !wbWizard ? 'block' : 'none';
  if (!wbWizard || wbMode !== 'guided') {
    wizardEl.innerHTML = '';
    return;
  }

  const { step, classId, moduleId, moduleLabel, availCourses, availSources, courseIds, sourceIds, favtags, favEnabled } = wbWizard;
  const cls = WB_CLASSES[classId] || WB_CLASSES.pharmaceutiques;
  const allModules = Array.isArray(window.__dashboardModules) ? window.__dashboardModules : [];
  const usedModuleIds = new Set(wbBlocks.map((b, idx) => (idx === wbEditingIndex ? null : String(b.moduleId))).filter(Boolean));
  const dots = Array.from({ length: 5 }, (_, s) => `<div class="wb-dot${s === step ? ' active' : s < step ? ' done' : ''}"></div>`).join('');

  let body = '';

  if (step === 0) {
    const cards = Object.values(WB_CLASSES)
      .map((c) => {
        const available = allModules.filter((m) => (m.module_class || 'pharmaceutiques').toLowerCase() === c.id && !usedModuleIds.has(String(m.id)));
        if (!available.length) return '';
        return `<button class="wb-class-card${classId === c.id ? ' selected' : ''}" data-class="${c.id}" type="button" style="--cc:${c.color};--cg:${c.ghost}">
          <div class="wb-cc-top"><i class="bi ${c.icon} wb-cc-icon"></i><span class="wb-cc-name">${c.name}</span></div>
          <div class="wb-cc-desc">${c.desc}</div>
        </button>`;
      })
      .join('');

    body = `<div class="wb-step-hd"><div class="wb-snum">1</div><span class="wb-slbl">Choisissez une categorie</span></div>
      <div class="wb-class-grid">${cards || '<span class="wb-empty">Aucune categorie disponible.</span>'}</div>`;
  }

  if (step === 1) {
    const mods = allModules.filter((m) => (m.module_class || 'pharmaceutiques').toLowerCase() === classId && !usedModuleIds.has(String(m.id)));
    const cards = mods
      .map((m) => {
        const icon = wbModuleIcon(m.name);
        return `<button class="wb-mod-card${moduleId === String(m.id) ? ' selected' : ''}" data-mid="${m.id}" data-mlbl="${m.name}" type="button">
          <div class="wb-mod-head"><i class="bi ${icon} wb-mod-icon"></i><span class="wb-mod-name">${m.name}</span></div>
        </button>`;
      })
      .join('');

    body = `<div class="wb-crumb" style="--cc:${cls.color}">
      <div class="wb-snum done"><i class="bi bi-check"></i></div>
      <span style="color:${cls.color};font-weight:700"><i class="bi ${cls.icon}"></i> ${cls.name}</span>
    </div>
    <div class="wb-step-hd"><div class="wb-snum">2</div><span class="wb-slbl">Choisissez un module</span></div>
    <div class="wb-mod-grid">${cards || '<span class="wb-empty">Aucun module disponible.</span>'}</div>
    <div class="wb-nav"><button class="wb-back" id="wbB1" type="button"><i class="bi bi-arrow-left"></i> Retour</button><span></span></div>`;
  }

  if (step === 2) {
    const chips = (availCourses || [])
      .map((c) => `<button class="wb-course-chip${courseIds.includes(c.id) ? ' selected' : ''}" data-cid="${c.id}" type="button">${c.label}</button>`)
      .join('');
    const countLabel = courseIds.length ? `${courseIds.length} selectionne(s)` : 'Tous si vide';

    body = `<div class="wb-crumb" style="--cc:${cls.color}">
      <div class="wb-snum done"><i class="bi bi-check"></i></div>
      <span style="color:${cls.color};font-weight:700"><i class="bi ${cls.icon}"></i> ${cls.name}</span>
      <span class="wb-crumb-val"><i class="bi ${wbModuleIcon(moduleLabel)}"></i> ${moduleLabel}</span>
    </div>
    <div class="wb-step-hd"><div class="wb-snum">3</div><span class="wb-slbl">Cours a inclure</span><span class="wb-sval">${countLabel}</span></div>
    <div class="wb-chips-wrap">${chips || '<span class="wb-empty">Aucun cours pour ce module.</span>'}</div>
    <div class="wb-nav"><button class="wb-back" id="wbB2" type="button"><i class="bi bi-arrow-left"></i> Retour</button><button class="wb-next" id="wbN2" type="button" style="background:${cls.color}">Suivant <i class="bi bi-arrow-right"></i></button></div>`;
  }

  if (step === 3) {
    const pills = (availSources || [])
      .map((s) => `<button class="wb-src-pill${sourceIds.includes(s.id) ? ' selected' : ''}" data-sid="${s.id}" type="button"><span class="wb-src-dot"></span><span>${s.label}</span>${sourceIds.includes(s.id) ? '<i class="bi bi-check wb-src-check"></i>' : ''}</button>`)
      .join('');
    const label = sourceIds.length ? `${sourceIds.length} selectionnee(s)` : 'Optionnel';

    body = `<div class="wb-crumb" style="--cc:${cls.color}">
      <div class="wb-snum done"><i class="bi bi-check"></i></div>
      <span style="color:${cls.color};font-weight:700"><i class="bi ${cls.icon}"></i> ${cls.name}</span>
      <span class="wb-crumb-val"><i class="bi ${wbModuleIcon(moduleLabel)}"></i> ${moduleLabel}</span>
    </div>
    <div class="wb-step-hd"><div class="wb-snum">4</div><span class="wb-slbl">Sources</span><span class="wb-sval">${label}</span></div>
    <div class="wb-src-grid">${pills || '<span class="wb-empty">Aucune source disponible.</span>'}</div>
    <div class="wb-nav"><button class="wb-back" id="wbB3" type="button"><i class="bi bi-arrow-left"></i> Retour</button><button class="wb-next" id="wbN3" type="button" style="background:${cls.color}">Suivant <i class="bi bi-arrow-right"></i></button></div>`;
  }

  if (step === 4) {
    const tagChips = wbFavtagCache
      .map((t) => `<button class="wb-fav-chip${favtags.includes(t.id) ? ' selected' : ''}" data-tid="${t.id}" type="button">${t.label}</button>`)
      .join('');

    body = `<div class="wb-crumb" style="--cc:${cls.color}">
      <div class="wb-snum done"><i class="bi bi-check"></i></div>
      <span style="color:${cls.color};font-weight:700"><i class="bi ${cls.icon}"></i> ${cls.name}</span>
      <span class="wb-crumb-val"><i class="bi ${wbModuleIcon(moduleLabel)}"></i> ${moduleLabel}</span>
    </div>
    <div class="wb-step-hd"><div class="wb-snum">5</div><span class="wb-slbl">Tags favoris</span><span class="wb-sval">Optionnel</span></div>
    <div class="wb-fav-toggle-row">
      <div class="wb-fav-toggle-left">
        <div class="wb-fav-icon"><i class="bi bi-heart-fill"></i></div>
        <div><div class="wb-fav-lbl">Filtrer par tag favori</div><div class="wb-fav-sub">Uniquement les questions marquees favoris</div></div>
      </div>
      <label class="toggle-switch"><input type="checkbox" id="wbFavToggle" ${favEnabled ? 'checked' : ''}><span class="toggle-slider"></span></label>
    </div>
    ${favEnabled ? `<div class="wb-chips-wrap wb-chips-fav">${tagChips || '<span class="wb-empty">Aucun tag favori.</span>'}</div>` : ''}
    <div class="wb-nav"><button class="wb-back" id="wbB4" type="button"><i class="bi bi-arrow-left"></i> Retour</button><button class="wb-confirm" id="wbConfirm" type="button"><i class="bi bi-check-lg"></i> ${wbEditingIndex !== null ? 'Mettre a jour le filtre' : 'Confirmer ce filtre'}</button></div>`;
  }

  wizardEl.innerHTML = `<div class="wb-wizard-wrap">
    <div class="wb-meta">
      <span class="wb-bloc-label">${wbEditingIndex !== null ? `Edition filtre ${wbEditingIndex + 1}` : wbBlocks.length ? `Bloc ${wbBlocks.length + 1}` : 'Nouveau filtre'}</span>
      <div class="wb-meta-right">
        <div class="wb-dots">${dots}</div>
        <button class="wb-cancel" id="wbCancelWizard" type="button">Annuler</button>
      </div>
    </div>
    ${body}
  </div>`;

  wbAttachWizardEvents();
}

function wbAttachWizardEvents() {
  if (!wbWizard) return;

  document.getElementById('wbCancelWizard')?.addEventListener('click', () => {
    wbWizard = null;
    wbEditingIndex = null;
    if (!wbBlocks.length) wbStartWizard();
    else {
      wbRender();
      wbApplyActiveFilters();
    }
  });

  if (wbWizard.step === 0) {
    document.querySelectorAll('.wb-class-card').forEach((card) => {
      card.addEventListener('click', () => {
        wbWizard.classId = card.dataset.class;
        wbWizard.moduleId = null;
        wbWizard.moduleLabel = '';
        wbWizard.courseIds = [];
        wbWizard.sourceIds = [];
        wbWizard.step = 1;
        wbRender();
        wbApplyActiveFilters();
      });
    });
  }

  if (wbWizard.step === 1) {
    document.getElementById('wbB1')?.addEventListener('click', () => {
      wbWizard.step = 0;
      wbRender();
    });

    document.querySelectorAll('.wb-mod-card').forEach((card) => {
      card.addEventListener('click', async () => {
        const mid = String(card.dataset.mid);
        wbWizard.moduleId = mid;
        wbWizard.moduleLabel = card.dataset.mlbl;
        wbWizard.courseIds = [];
        wbWizard.sourceIds = [];
        wbWizard.availCourses = await wbFetchCourses(mid);
        wbWizard.availSources = await wbFetchSources(mid);
        wbWizard.step = 2;
        wbRender();
        wbApplyActiveFilters();
      });
    });
  }

  if (wbWizard.step === 2) {
    document.getElementById('wbB2')?.addEventListener('click', () => {
      wbWizard.step = 1;
      wbRender();
    });
    document.getElementById('wbN2')?.addEventListener('click', () => {
      wbWizard.step = 3;
      wbRender();
    });
    document.querySelectorAll('.wb-course-chip').forEach((chip) => {
      chip.addEventListener('click', () => {
        const cid = chip.dataset.cid;
        const i = wbWizard.courseIds.indexOf(cid);
        if (i >= 0) { wbWizard.courseIds.splice(i, 1); chip.classList.remove('selected'); }
        else         { wbWizard.courseIds.push(cid);    chip.classList.add('selected'); }
        const sval = document.querySelector('#wb-wizard .wb-sval');
        if (sval) sval.textContent = wbWizard.courseIds.length
          ? `${wbWizard.courseIds.length} selectionne(s)` : 'Tous si vide';
        wbApplyActiveFilters();
      });
    });
  }

  if (wbWizard.step === 3) {
    document.getElementById('wbB3')?.addEventListener('click', () => {
      wbWizard.step = 2;
      wbRender();
    });
    document.getElementById('wbN3')?.addEventListener('click', () => {
      wbWizard.step = 4;
      wbRender();
    });
    document.querySelectorAll('.wb-src-pill').forEach((pill) => {
      pill.addEventListener('click', () => {
        const sid = pill.dataset.sid;
        const i = wbWizard.sourceIds.indexOf(sid);
        if (i >= 0) {
          wbWizard.sourceIds.splice(i, 1);
          pill.classList.remove('selected');
          pill.querySelector('.wb-src-check')?.remove();
        } else {
          wbWizard.sourceIds.push(sid);
          pill.classList.add('selected');
          if (!pill.querySelector('.wb-src-check')) {
            const chk = document.createElement('i');
            chk.className = 'bi bi-check wb-src-check';
            pill.appendChild(chk);
          }
        }
        const sval = document.querySelector('#wb-wizard .wb-sval');
        if (sval) sval.textContent = wbWizard.sourceIds.length
          ? `${wbWizard.sourceIds.length} selectionnee(s)` : 'Optionnel';
        wbApplyActiveFilters();
      });
    });
  }

  if (wbWizard.step === 4) {
    document.getElementById('wbB4')?.addEventListener('click', () => {
      wbWizard.step = 3;
      wbRender();
    });
    document.getElementById('wbFavToggle')?.addEventListener('change', (e) => {
      wbWizard.favEnabled = e.target.checked;
      if (!wbWizard.favEnabled) wbWizard.favtags = [];
      wbRender();
      wbApplyActiveFilters();
    });
    document.querySelectorAll('.wb-fav-chip').forEach((chip) => {
      chip.addEventListener('click', () => {
        const tid = chip.dataset.tid;
        const i = wbWizard.favtags.indexOf(tid);
        if (i >= 0) { wbWizard.favtags.splice(i, 1); chip.classList.remove('selected'); }
        else         { wbWizard.favtags.push(tid);    chip.classList.add('selected'); }
        wbApplyActiveFilters();
      });
    });
    document.getElementById('wbConfirm')?.addEventListener('click', () => {
      const ready = {
        ...wbWizard,
        courseIds: [...(wbWizard.courseIds || [])],
        sourceIds: [...(wbWizard.sourceIds || [])],
        favtags: wbWizard.favEnabled ? [...(wbWizard.favtags || [])] : []
      };
      if (!ready.moduleId) return;
      if (wbEditingIndex !== null && wbBlocks[wbEditingIndex]) wbBlocks[wbEditingIndex] = ready;
      else wbBlocks.push(ready);
      wbWizard = null;
      wbEditingIndex = null;
      wbRender();
      wbApplyActiveFilters();
    });
  }
}

function wbPopulateAdvancedSelect(targetId, nativeId) {
  const target = document.getElementById(targetId);
  const native = document.getElementById(nativeId);
  if (!target || !native) return;

  const previous = new Set(Array.from(target.selectedOptions).map((o) => o.value));
  const nativeSelected = new Set(Array.from(native.selectedOptions).map((o) => o.value));
  target.innerHTML = Array.from(native.options)
    .map((o) => `<option value="${o.value}">${o.textContent}</option>`)
    .join('');

  Array.from(target.options).forEach((o) => {
    o.selected = previous.size ? previous.has(o.value) : nativeSelected.has(o.value);
  });
}

function wbPopulateAdvancedFromNative() {
  wbPopulateAdvancedSelect('wb_adv_module', 'sel_module');
  wbPopulateAdvancedSelect('wb_adv_course', 'sel_course');
  wbPopulateAdvancedSelect('wb_adv_source', 'sel_source');
  wbPopulateAdvancedSelect('wb_adv_favtag', 'sel_favtag');
}

function wbSetMode(mode) {
  wbMode = mode === 'advanced' ? 'advanced' : 'guided';
  const guidedBtn = document.getElementById('wbGuidedBtn');
  const advancedBtn = document.getElementById('wbAdvancedBtn');
  const guidedWrap = document.getElementById('wb-guided-mode');
  const advancedWrap = document.getElementById('wb-advanced-mode');

  guidedBtn?.classList.toggle('active', wbMode === 'guided');
  advancedBtn?.classList.toggle('active', wbMode === 'advanced');
  guidedWrap?.classList.toggle('hidden', wbMode !== 'guided');
  advancedWrap?.classList.toggle('hidden', wbMode !== 'advanced');

  if (wbMode === 'guided' && !wbWizard && !wbBlocks.length) wbStartWizard();
  if (wbMode === 'advanced') wbPopulateAdvancedFromNative();
  wbApplyActiveFilters();
}

function wbWireCommonEvents() {
  document.getElementById('wb-add-btn')?.addEventListener('click', () => wbStartWizard());

  document.getElementById('filterResetBtn')?.addEventListener('click', () => {
    wbBlocks = [];
    wbWizard = null;
    wbEditingIndex = null;

    ['wb_adv_module', 'wb_adv_course', 'wb_adv_source', 'wb_adv_favtag'].forEach((id) => {
      const el = document.getElementById(id);
      if (!el) return;
      Array.from(el.options).forEach((o) => {
        o.selected = false;
      });
    });

    wbRender();
    wbApplyActiveFilters();
    if (wbMode === 'guided') wbStartWizard();
  });

  document.getElementById('wbGuidedBtn')?.addEventListener('click', () => wbSetMode('guided'));
  document.getElementById('wbAdvancedBtn')?.addEventListener('click', () => wbSetMode('advanced'));

  ['wb_adv_module', 'wb_adv_course', 'wb_adv_source', 'wb_adv_favtag'].forEach((id) => {
    document.getElementById(id)?.addEventListener('change', () => {
      if (wbMode === 'advanced') wbApplyAdvancedFilters();
    });
  });

  window.addEventListener('dashboard:modules-loaded', () => {
    wbRender();
    wbPopulateAdvancedFromNative();
    wbApplyActiveFilters();
  });
}

wbWireCommonEvents();
wbStartWizard();
wbSetMode('guided');

[['training_question_count', 'training_slider_max'], ['exam_question_count', 'exam_slider_max']].forEach(([sid, mid]) => {
  const slider = document.getElementById(sid);
  const maxLabel = document.getElementById(mid);
  if (!slider || !maxLabel) return;
  new MutationObserver(() => {
    maxLabel.textContent = slider.max || '-';
  }).observe(slider, { attributes: true, attributeFilter: ['max'] });
});
</script>
<script src="js/profile-link.js"></script>
</body>
</html>


