<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Galien - Tableau de bord</title>
<link rel="icon" type="image/svg+xml" href="assets/galien-icon.svg">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="dashboard-wrap">
  <div class="dash-topbar">
    <div class="dash-brand brand-with-icon topbar-logo" aria-label="Galien">
      <img src="assets/galien-icon.svg" alt="Galien" class="brand-icon">
    </div>
    <div id="dashUserArea"></div>
  </div>

  <div class="dashboard-main">
    <div class="dashboard-card">
      <h2>Nouvelle session</h2>
      <p class="muted" style="margin-bottom:22px">Choisissez votre mode, filtrez par module, cours ou source, puis lancez.</p>

      <div class="mode-cards">
        <button class="mode-card selected" id="modeTraining" type="button">
          <div class="mode-card-icon"><i class="bi bi-lightning-charge-fill"></i></div>
          <h4>Entrainement</h4>
          <p>Correction immediate avec explications. Avance automatique possible.</p>
        </button>
        <button class="mode-card" id="modeExam" type="button">
          <div class="mode-card-icon"><i class="bi bi-clock-fill"></i></div>
          <h4>Examen</h4>
          <p>Minuteur, pas d'explication pendant la session. Resultats a la fin.</p>
        </button>
      </div>

      <!-- Hidden native selects â€” read by dashboard.js unchanged -->
      <select id="sel_module" class="multi-select" multiple style="display:none"></select>
      <select id="sel_course" class="multi-select" multiple style="display:none"></select>
      <select id="sel_source" class="multi-select" multiple style="display:none"></select>
      <select id="sel_favtag" class="multi-select" multiple style="display:none"></select>

      <!-- Wizard filter builder -->
      <div class="dash-panel wb-panel">
        <div class="wb-header">
          <div class="dash-panel-title" style="margin-bottom:0"><i class="bi bi-funnel"></i> Filtres de session</div>
          <button class="filter-reset-btn" id="filterResetBtn" type="button">
            <i class="bi bi-arrow-counterclockwise"></i> RÃ©initialiser
          </button>
        </div>
        <div id="wb-blocks"></div>
        <div id="wb-wizard"></div>
        <div id="wb-add-wrap" style="display:none;padding:12px 0 0">
          <button class="wb-add-btn" id="wb-add-btn" type="button">
            <i class="bi bi-plus-circle"></i> Ajouter un autre module
          </button>
        </div>
        <div class="filters-count-wrap" style="margin-top:12px">
          <div class="question-counter">
            <span class="question-counter-num js-questions-count">â€¦</span>
            <span class="question-counter-label">questions disponibles</span>
          </div>
        </div>
      </div>

      <div class="dash-panel" id="trainingPanel">
        <div class="dash-panel-title"><i class="bi bi-lightning-charge"></i> Options entrainement</div>
        <div class="filters-row" style="margin-bottom:12px">
          <div class="field" style="margin-bottom:0">
            <span>Systeme de correction</span>
            <select id="training_correction_system">
              <option value="tout_ou_rien">Tout ou rien</option>
              <option value="partiel_positive">Partiel positif</option>
              <option value="partiel_negative">Partiel negatif</option>
            </select>
          </div>
          <div class="field" style="margin-bottom:0">
            <div class="qcount-slider-wrap">
              <div class="slider-header">
                <span>Nombre de questions</span>
                <div class="slider-count">
                  <strong id="training_question_count_value">1 <span>questions</span></strong>
                </div>
              </div>
              <input type="range" id="training_question_count" min="1" value="1">
              <div class="slider-ends">
                <span>1</span>
                <span id="training_slider_max">â€”</span>
              </div>
            </div>
          </div>
        </div>
        <div class="toggle-row" style="border-top:none;padding-top:0">
          <div class="toggle-label">
            Avance automatique apres correction
            <small>Passe a la question suivante automatiquement</small>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="autoAdvanceToggle">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div id="delayPanel" class="hidden" style="margin-top:12px">
          <div class="delay-row">
            <div class="field" style="margin-bottom:0">
              <span>Delai rapide</span>
              <select id="delayPreset">
                <option value="2">2 secondes</option>
                <option value="5">5 secondes</option>
                <option value="10">10 secondes</option>
                <option value="custom">Personnalise...</option>
              </select>
            </div>
            <div class="delay-input-wrap hidden" id="customDelayWrap">
              <span>Secondes</span>
              <input type="number" id="customDelay" min="1" max="60" placeholder="Ex: 7" style="width:90px">
            </div>
          </div>
        </div>
      </div>

      <div class="dash-panel hidden" id="examPanel">
        <div class="dash-panel-title"><i class="bi bi-clock"></i> Options examen</div>
        <div class="filters-row" style="margin-bottom:12px">
          <div class="field" style="margin-bottom:0">
            <span>Duree (minutes)</span>
            <input type="number" id="exam_minutes" min="1" placeholder="Ex: 30">
          </div>
          <div class="field" style="margin-bottom:0">
            <span>Systeme de correction</span>
            <select id="correction_system">
              <option value="tout_ou_rien">Tout ou rien</option>
              <option value="partiel_positive">Partiel positif</option>
              <option value="partiel_negative">Partiel negatif</option>
            </select>
          </div>
          <div class="field" style="margin-bottom:0">
            <div class="qcount-slider-wrap">
              <div class="slider-header">
                <span>Nombre de questions</span>
                <div class="slider-count">
                  <strong id="exam_question_count_value">1 <span>questions</span></strong>
                </div>
              </div>
              <input type="range" id="exam_question_count" min="1" value="1">
              <div class="slider-ends">
                <span>1</span>
                <span id="exam_slider_max">â€”</span>
              </div>
            </div>
          </div>
        </div>
        <div class="help-text" id="correctionHelp">Vous devez cocher toutes les bonnes reponses et uniquement celles-ci.</div>
      </div>

      <button class="btn start-btn" id="startBtn" type="button"><i class="bi bi-play-fill"></i> Commencer</button>
      <button class="btn ghost hidden" id="resumeBtn" type="button" style="margin-top:8px"><i class="bi bi-arrow-counterclockwise"></i> Reprendre la session en cours</button>
    </div>
  </div>
</div>

<script src="js/api.js"></script>
<script src="js/theme.js"></script>
<script src="js/dashboard.js"></script>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GALIEN â€” Wizard Filter Builder v2
   5-step wizard per block: classe â†’ module â†’ cours â†’ sources â†’ tags
   Syncs to hidden native <select>s so dashboard.js works unchanged.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Class catalogue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const WB_CLASSES = {
  biologiques:     { id:'biologiques',     name:'Biologiques',     icon:'ğŸ§«', color:'#0d9488', ghost:'#f0fdfa', desc:'Biochimie Â· HÃ©mobiologie Â· Microbiologie Â· Parasitologie Â· Immunologie' },
  fondamentaux:    { id:'fondamentaux',    name:'Fondamentaux',    icon:'âš—ï¸',  color:'#7c3aed', ghost:'#f5f3ff', desc:'Biophysique Â· Chimie analytique Â· Chimie minÃ©rale Â· Hydrobromatologie' },
  pharmaceutiques: { id:'pharmaceutiques', name:'Pharmaceutiques', icon:'ğŸ’Š', color:'#d97706', ghost:'#fffbeb', desc:'Pharmacologie Â· GalÃ©nique Â· Toxicologie Â· Pharmacognosieâ€¦' },
};

/* â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let wbBlocks  = [];    // confirmed filter blocks
let wbWizard  = null;  // active wizard: {step,classId,moduleId,moduleLabel,availCourses,availSources,courseIds,sourceIds,favtags,favEnabled}
let wbCourseCache = {}; // moduleId â†’ [{id,label}]
let wbSourceCache = {}; // moduleId â†’ [{id,label}]
let wbFavtagCache = []; // [{id,label}]

/* â”€â”€ Hook into dashboard.js setOptions so favtag cache stays fresh â”€â”€ */
(function(){
  const _orig = window.setOptions;
  if (typeof _orig !== 'function') return;
  window.setOptions = function(selectEl, items, getLabel, selectedValues) {
    _orig(selectEl, items, getLabel, selectedValues);
    if (selectEl && selectEl.id === 'sel_favtag') {
      wbFavtagCache = Array.from(selectEl.options).map(o => ({ id: o.value, label: o.textContent.trim() }));
      if (wbWizard && wbWizard.step === 4) wbRender();
    }
    if (selectEl && selectEl.id === 'sel_course') {
      items.forEach(c => {
        const mid = String(c.module_id);
        if (!wbCourseCache[mid]) wbCourseCache[mid] = [];
        if (!wbCourseCache[mid].find(x => x.id === String(c.id ?? c.value)))
          wbCourseCache[mid].push({ id: String(c.id ?? c.value), label: getLabel(c) });
      });
    }
    if (selectEl && selectEl.id === 'sel_source') {
      items.forEach(s => {
        const mid = String(s.module_id || '');
        if (!mid) return;
        if (!wbSourceCache[mid]) wbSourceCache[mid] = [];
        if (!wbSourceCache[mid].find(x => x.id === String(s.id ?? s.value)))
          wbSourceCache[mid].push({ id: String(s.id ?? s.value), label: getLabel(s) });
      });
    }
  };
})();

/* â”€â”€ Sync blocks â†’ native selects (triggers dashboard.js count) â”€â”€ */
function wbSync() {
  const sm = document.getElementById('sel_module');
  const sc = document.getElementById('sel_course');
  const ss = document.getElementById('sel_source');
  const sf = document.getElementById('sel_favtag');

  if (!wbBlocks.length) {
    [sm, sc, ss, sf].forEach(el => {
      if (el) Array.from(el.options).forEach(o => o.selected = false);
    });
    if (typeof scheduleCountRefresh === 'function') scheduleCountRefresh();
    return;
  }

  const allModuleIds  = new Set(wbBlocks.map(b => b.moduleId));
  const allCourseIds  = new Set(wbBlocks.flatMap(b => b.courseIds));
  const allSourceIds  = new Set(wbBlocks.flatMap(b => b.sourceIds));
  const allFavtags    = new Set(wbBlocks.flatMap(b => b.favtags));

  // Modules: select exactly the chosen ones, then fire change so
  // dashboard.js refreshes sel_course / sel_source lists
  if (sm) {
    Array.from(sm.options).forEach(o => { o.selected = allModuleIds.has(o.value); });
    sm.dispatchEvent(new Event('change'));
  }

  // Courses & sources: applied after dashboard.js repopulates them (via Promise micro-task)
  setTimeout(() => {
    if (sc) Array.from(sc.options).forEach(o => { o.selected = !allCourseIds.size || allCourseIds.has(o.value); });
    if (ss) Array.from(ss.options).forEach(o => { o.selected = !allSourceIds.size || allSourceIds.has(o.value); });
    if (sf) Array.from(sf.options).forEach(o => { o.selected = allFavtags.has(o.value); });
    if (typeof scheduleCountRefresh === 'function') scheduleCountRefresh();
  }, 350);
}

/* â”€â”€ API helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function wbFetchCourses(moduleId) {
  const mid = String(moduleId);
  if (wbCourseCache[mid]) return wbCourseCache[mid];
  try {
    const res = await fetch(`${API_URL}/courses`);
    if (!res.ok) return [];
    const all = await res.json();
    all.forEach(c => {
      const m = String(c.module_id);
      if (!wbCourseCache[m]) wbCourseCache[m] = [];
      if (!wbCourseCache[m].find(x => x.id === String(c.id)))
        wbCourseCache[m].push({ id: String(c.id), label: c.name });
    });
    return wbCourseCache[mid] || [];
  } catch { return []; }
}

async function wbFetchSources(moduleId) {
  const mid = String(moduleId);
  if (wbSourceCache[mid]) return wbSourceCache[mid];
  try {
    const res = await fetch(`${API_URL}/sources?module_id=${mid}`);
    if (!res.ok) return [];
    const arr = await res.json();
    wbSourceCache[mid] = arr.map(s => ({ id: String(s.id), label: s.name }));
    return wbSourceCache[mid];
  } catch { return []; }
}

/* â”€â”€ Main render entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function wbRender() {
  _wbRenderBlocks();
  _wbRenderWizard();
  const addWrap = document.getElementById('wb-add-wrap');
  if (addWrap) addWrap.style.display = (wbBlocks.length > 0 && !wbWizard) ? 'block' : 'none';
}

/* â”€â”€ Render confirmed blocks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function _wbRenderBlocks() {
  const el = document.getElementById('wb-blocks');
  if (!el) return;
  if (!wbBlocks.length) { el.innerHTML = ''; return; }
  el.innerHTML = wbBlocks.map((b, i) => {
    const cls = WB_CLASSES[b.classId] || WB_CLASSES.pharmaceutiques;
    const courseChips = b.courseIds.length
      ? b.courseIds.map(id => { const c = b.availCourses.find(x => x.id === id); return `<span class="wb-chip wb-chip--course">${c?.label || id}</span>`; }).join('')
      : `<span class="wb-chip wb-chip--muted">Tous les cours</span>`;
    const sourceChips = b.sourceIds.map(id => { const s = b.availSources.find(x => x.id === id); return `<span class="wb-chip wb-chip--source"><i class="bi bi-file-earmark-text"></i> ${s?.label || id}</span>`; }).join('');
    const favChips   = b.favtags.map(t => `<span class="wb-chip wb-chip--fav"><i class="bi bi-heart-fill"></i> ${t}</span>`).join('');
    return `<div class="wb-block">
      <div class="wb-block-num" style="background:${cls.color}">${i+1}</div>
      <div class="wb-block-info">
        <div class="wb-block-title">
          <span class="wb-block-cls" style="color:${cls.color}">${cls.icon} ${cls.name}</span>
          <span class="wb-block-mod">${b.moduleLabel}</span>
        </div>
        <div class="wb-block-chips">${courseChips}${sourceChips}${favChips}</div>
      </div>
      <button class="wb-del-btn" data-del="${i}" title="Supprimer"><i class="bi bi-trash"></i></button>
    </div>`;
  }).join('');
  el.querySelectorAll('[data-del]').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      wbBlocks.splice(parseInt(btn.dataset.del), 1);
      if (!wbBlocks.length && !wbWizard) wbStartWizard();
      else { wbSync(); wbRender(); }
    });
  });
}

/* â”€â”€ Render wizard steps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function _wbRenderWizard() {
  const el = document.getElementById('wb-wizard');
  if (!el) return;
  if (!wbWizard) { el.innerHTML = ''; return; }

  const { step, classId, moduleId, moduleLabel, availCourses, availSources, courseIds, sourceIds, favtags, favEnabled } = wbWizard;
  const cls = WB_CLASSES[classId];
  const usedModuleIds = new Set(wbBlocks.map(b => b.moduleId));
  const allModules = Array.isArray(window.__dashboardModules) ? window.__dashboardModules : [];
  const STEPS = 5;

  const dots = Array.from({length: STEPS}, (_, s) =>
    `<div class="wb-dot${s === step ? ' active' : s < step ? ' done' : ''}"></div>`
  ).join('');

  let body = '';

  /* â”€â”€ Step 0: Classe â”€â”€ */
  if (step === 0) {
    const cards = Object.values(WB_CLASSES).map(c => {
      const avail = allModules.filter(m => (m.module_class || 'pharmaceutiques').toLowerCase() === c.id && !usedModuleIds.has(String(m.id)));
      if (!avail.length) return '';
      const totalQ = avail.reduce((s, m) => s + (m.count || 0), 0);
      const sel = classId === c.id;
      return `<button class="wb-class-card${sel ? ' selected' : ''}" data-class="${c.id}"
        style="--cc:${c.color};--cg:${c.ghost}" type="button">
        <div class="wb-cc-top"><span class="wb-cc-icon">${c.icon}</span><span class="wb-cc-name">${c.name}</span></div>
        <div class="wb-cc-desc">${c.desc}</div>
        <div class="wb-cc-count" style="color:${c.color}">${avail.length} module${avail.length>1?'s':''}${totalQ ? ` Â· ${totalQ} Q` : ''}</div>
      </button>`;
    }).join('');
    body = `
      <div class="wb-step-hd"><div class="wb-snum">1</div><span class="wb-slbl">Choisissez une classe</span></div>
      <div class="wb-class-grid">${cards || '<span class="wb-empty">Tous les modules dÃ©jÃ  sÃ©lectionnÃ©s.</span>'}</div>
      <div class="wb-nav"><span></span>
        <button class="wb-next" id="wbN0" ${!classId?'disabled':''} ${cls?`style="background:${cls.color}"`:''}>
          Suivant <i class="bi bi-arrow-right"></i>
        </button>
      </div>`;
  }

  /* â”€â”€ Step 1: Module â”€â”€ */
  else if (step === 1) {
    const mods = allModules.filter(m => (m.module_class || 'pharmaceutiques').toLowerCase() === classId && !usedModuleIds.has(String(m.id)));
    const cards = mods.map(m => {
      const sel = moduleId === String(m.id);
      return `<button class="wb-mod-card${sel?' selected':''}" data-mid="${m.id}" data-mlbl="${m.name}" type="button">
        <div class="wb-mod-name">${m.name}</div>
        ${m.count ? `<div class="wb-mod-count">${m.count} Q</div>` : ''}
      </button>`;
    }).join('');
    body = `
      <div class="wb-crumb" style="--cc:${cls.color}">
        <div class="wb-snum done"><i class="bi bi-check"></i></div>
        <span style="color:${cls.color};font-weight:700">${cls.icon} ${cls.name}</span>
      </div>
      <div class="wb-step-hd"><div class="wb-snum">2</div><span class="wb-slbl">Choisissez un module</span></div>
      <div class="wb-mod-grid">${cards || '<span class="wb-empty">Aucun module disponible.</span>'}</div>
      <div class="wb-nav">
        <button class="wb-back" id="wbB1"><i class="bi bi-arrow-left"></i> Retour</button>
        <button class="wb-next" id="wbN1" ${!moduleId?'disabled':''} ${cls?`style="background:${cls.color}"`:''}>Suivant <i class="bi bi-arrow-right"></i></button>
      </div>`;
  }

  /* â”€â”€ Step 2: Cours â”€â”€ */
  else if (step === 2) {
    const label = courseIds.length ? `${courseIds.length} sÃ©lectionnÃ©${courseIds.length>1?'s':''}` : 'Tous si vide';
    const chips = availCourses.map(c => {
      const sel = courseIds.includes(c.id);
      return `<button class="wb-course-chip${sel?' selected':''}" data-cid="${c.id}" type="button">${c.label}</button>`;
    }).join('');
    body = `
      <div class="wb-crumb" style="--cc:${cls.color}">
        <div class="wb-snum done"><i class="bi bi-check"></i></div>
        <span style="color:${cls.color};font-weight:700">${cls.icon} ${cls.name}</span>
        <span class="wb-crumb-val">${moduleLabel}</span>
      </div>
      <div class="wb-step-hd">
        <div class="wb-snum">3</div><span class="wb-slbl">Cours Ã  inclure</span>
        <span class="wb-sval">${label}</span>
      </div>
      <div class="wb-chips-wrap">${chips || '<span class="wb-empty">Aucun cours pour ce module.</span>'}</div>
      <div class="wb-nav">
        <button class="wb-back" id="wbB2"><i class="bi bi-arrow-left"></i> Retour</button>
        <button class="wb-next" id="wbN2" ${cls?`style="background:${cls.color}"`:''}>Suivant <i class="bi bi-arrow-right"></i></button>
      </div>`;
  }

  /* â”€â”€ Step 3: Sources â”€â”€ */
  else if (step === 3) {
    const slabel = sourceIds.length ? `${sourceIds.length} sÃ©lectionnÃ©e${sourceIds.length>1?'s':''}` : 'optionnel';
    const pills = availSources.map(s => {
      const sel = sourceIds.includes(s.id);
      return `<div class="wb-src-pill${sel?' selected':''}" data-sid="${s.id}">
        <div class="wb-src-dot"></div><span>${s.label}</span>
        ${sel?'<i class="bi bi-check wb-src-check"></i>':''}
      </div>`;
    }).join('');
    body = `
      <div class="wb-crumb" style="--cc:${cls.color}">
        <div class="wb-snum done"><i class="bi bi-check"></i></div>
        <span style="color:${cls.color};font-weight:700">${cls.icon} ${cls.name}</span>
        <span class="wb-crumb-val">${moduleLabel}${courseIds.length ? ` Â· ${courseIds.length} cours` : ''}</span>
      </div>
      <div class="wb-step-hd">
        <div class="wb-snum">4</div><span class="wb-slbl">Sources</span>
        <span class="wb-sval">${slabel}</span>
      </div>
      <div class="wb-src-grid">${pills || '<span class="wb-empty">Aucune source disponible.</span>'}</div>
      <div class="wb-nav">
        <button class="wb-back" id="wbB3"><i class="bi bi-arrow-left"></i> Retour</button>
        <button class="wb-next" id="wbN3" ${cls?`style="background:${cls.color}"`:''}>Suivant <i class="bi bi-arrow-right"></i></button>
      </div>`;
  }

  /* â”€â”€ Step 4: Tags favoris â”€â”€ */
  else if (step === 4) {
    const tagChips = wbFavtagCache.map(t => {
      const sel = favtags.includes(t.id);
      return `<button class="wb-fav-chip${sel?' selected':''}" data-tid="${t.id}" type="button">${t.label}</button>`;
    }).join('');
    body = `
      <div class="wb-crumb" style="--cc:${cls.color}">
        <div class="wb-snum done"><i class="bi bi-check"></i></div>
        <span style="color:${cls.color};font-weight:700">${cls.icon} ${cls.name}</span>
        <span class="wb-crumb-val">${moduleLabel}${sourceIds.length ? ` Â· ${sourceIds.length} source${sourceIds.length>1?'s':''}` : ''}</span>
      </div>
      <div class="wb-step-hd">
        <div class="wb-snum">5</div><span class="wb-slbl">Tags favoris</span>
        <span class="wb-sval" style="color:var(--ink-4)">optionnel</span>
      </div>
      <div class="wb-fav-toggle-row">
        <div class="wb-fav-toggle-left">
          <div class="wb-fav-icon"><i class="bi bi-heart-fill"></i></div>
          <div><div class="wb-fav-lbl">Filtrer par tag favori</div><div class="wb-fav-sub">Uniquement les questions marquÃ©es</div></div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="wbFavToggle" ${favEnabled?'checked':''}>
          <span class="toggle-slider"></span>
        </label>
      </div>
      ${favEnabled ? `<div class="wb-chips-wrap wb-chips-fav">${tagChips || '<span class="wb-empty">Aucun tag favori trouvÃ©.</span>'}</div>` : ''}
      <div class="wb-nav">
        <button class="wb-back" id="wbB4"><i class="bi bi-arrow-left"></i> Retour</button>
        <button class="wb-confirm" id="wbConfirm"><i class="bi bi-check-lg"></i> Confirmer ce filtre</button>
      </div>`;
  }

  el.innerHTML = `<div class="wb-wizard-wrap">
    <div class="wb-meta">
      <span class="wb-bloc-label">${wbBlocks.length ? `Bloc ${wbBlocks.length+1}` : 'Nouveau filtre'}</span>
      <div class="wb-dots">${dots}</div>
    </div>
    ${body}
  </div>`;
  _wbAttach();
}

/* â”€â”€ Event wiring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function _wbAttach() {
  const { step } = wbWizard;

  if (step === 0) {
    document.querySelectorAll('.wb-class-card').forEach(card => {
      card.addEventListener('click', () => {
        if (wbWizard.classId !== card.dataset.class) { wbWizard.moduleId = null; wbWizard.moduleLabel = ''; wbWizard.courseIds = []; wbWizard.sourceIds = []; }
        wbWizard.classId = card.dataset.class;
        wbRender();
      });
    });
    document.getElementById('wbN0')?.addEventListener('click', () => { wbWizard.step = 1; wbRender(); });
  }
  else if (step === 1) {
    document.querySelectorAll('.wb-mod-card').forEach(card => {
      card.addEventListener('click', async () => {
        const mid = String(card.dataset.mid);
        if (wbWizard.moduleId !== mid) { wbWizard.courseIds = []; wbWizard.sourceIds = []; }
        wbWizard.moduleId = mid;
        wbWizard.moduleLabel = card.dataset.mlbl;
        wbWizard.availCourses = await wbFetchCourses(mid);
        wbWizard.availSources = await wbFetchSources(mid);
        wbRender();
      });
    });
    document.getElementById('wbB1')?.addEventListener('click', () => { wbWizard.step = 0; wbRender(); });
    document.getElementById('wbN1')?.addEventListener('click', () => { wbWizard.step = 2; wbRender(); });
  }
  else if (step === 2) {
    document.querySelectorAll('.wb-course-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const cid = chip.dataset.cid;
        const i = wbWizard.courseIds.indexOf(cid);
        if (i >= 0) wbWizard.courseIds.splice(i, 1); else wbWizard.courseIds.push(cid);
        wbRender();
      });
    });
    document.getElementById('wbB2')?.addEventListener('click', () => { wbWizard.step = 1; wbRender(); });
    document.getElementById('wbN2')?.addEventListener('click', () => { wbWizard.step = 3; wbRender(); });
  }
  else if (step === 3) {
    document.querySelectorAll('.wb-src-pill').forEach(pill => {
      pill.addEventListener('click', () => {
        const sid = pill.dataset.sid;
        const i = wbWizard.sourceIds.indexOf(sid);
        if (i >= 0) wbWizard.sourceIds.splice(i, 1); else wbWizard.sourceIds.push(sid);
        wbRender();
      });
    });
    document.getElementById('wbB3')?.addEventListener('click', () => { wbWizard.step = 2; wbRender(); });
    document.getElementById('wbN3')?.addEventListener('click', () => { wbWizard.step = 4; wbRender(); });
  }
  else if (step === 4) {
    document.getElementById('wbFavToggle')?.addEventListener('change', e => {
      wbWizard.favEnabled = e.target.checked;
      if (!e.target.checked) wbWizard.favtags = [];
      wbRender();
    });
    document.querySelectorAll('.wb-fav-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const tid = chip.dataset.tid;
        const i = wbWizard.favtags.indexOf(tid);
        if (i >= 0) wbWizard.favtags.splice(i, 1); else wbWizard.favtags.push(tid);
        wbRender();
      });
    });
    document.getElementById('wbB4')?.addEventListener('click', () => { wbWizard.step = 3; wbRender(); });
    document.getElementById('wbConfirm')?.addEventListener('click', () => {
      wbBlocks.push({ ...wbWizard });
      wbWizard = null;
      wbSync();
      wbRender();
    });
  }
}

/* â”€â”€ Init / Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function wbStartWizard() {
  wbWizard = { step:0, classId:null, moduleId:null, moduleLabel:'', availCourses:[], availSources:[], courseIds:[], sourceIds:[], favtags:[], favEnabled:false };
  wbRender();
}

document.getElementById('wb-add-btn')?.addEventListener('click', wbStartWizard);
document.getElementById('filterResetBtn')?.addEventListener('click', () => {
  wbBlocks = []; wbWizard = null;
  wbSync();
  wbStartWizard();
});

window.addEventListener('dashboard:modules-loaded', () => wbRender());
wbStartWizard();

/* â”€â”€ Slider max label sync (unchanged from original) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
[['training_question_count','training_slider_max'],['exam_question_count','exam_slider_max']].forEach(([sid,mid])=>{
  const s=document.getElementById(sid), m=document.getElementById(mid);
  if(s&&m) new MutationObserver(()=>{ m.textContent=s.max||'â€”'; }).observe(s,{attributes:true,attributeFilter:['max']});
});
</script>
<script src="js/profile-link.js"></script>
</body>
</html>
